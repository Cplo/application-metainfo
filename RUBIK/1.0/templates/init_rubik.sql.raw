DROP TABLE IF EXISTS cd_statistic_info, cd_table_join;
DROP TABLE IF EXISTS cd_sub_task, cd_task, cd_measure, cd_cube_hierarchy, cd_group_by, cd_cube_creation_sql, cd_cube;
DROP TABLE IF EXISTS cd_expression, cd_model_dimension, cd_model;
DROP TABLE IF EXISTS cd_hierarchy_level, cd_hierarchy, cd_attribute, cd_level, cd_dimension;
DROP TABLE IF EXISTS cd_table_reference;
DROP TABLE IF EXISTS cd_project;
DROP TABLE IF EXISTS cd_server_connection;


# server connection
CREATE TABLE `cd_server_connection` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `host` varchar(255) NOT NULL,
  `port` int(11) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `user_name` varchar(255) DEFAULT NULL,
  `password` varchar(255) DEFAULT NULL,
  `security_type` varchar(45) DEFAULT 'NONE',
  `principal` varchar(255) DEFAULT NULL,
  `owner` varchar(255) NOT NULL DEFAULT 'hive',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=148 DEFAULT CHARSET=utf8;


# project
CREATE TABLE `cd_project` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `server_connection_id` bigint(20) NOT NULL,
  `owner` varchar(255) NOT NULL DEFAULT 'hive',
  PRIMARY KEY (`id`),
  KEY `fk_project_1_idx` (`server_connection_id`),
  KEY `key_word_1` (`name`),
  CONSTRAINT `fk_cd_project_1` FOREIGN KEY (`server_connection_id`) REFERENCES `cd_server_connection` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=209 DEFAULT CHARSET=utf8;

#table reference
CREATE TABLE `cd_table_reference` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `database` varchar(255) NOT NULL,
  `table_name` varchar(255) NOT NULL,
  `table_type` varchar(45) DEFAULT 'NORMAL_TABLE',
  `project_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_table_reference_1_idx` (`project_id`),
  KEY `search_keyword_1` (`table_name`),
  CONSTRAINT `fk_cd_table_reference_1` FOREIGN KEY (`project_id`) REFERENCES `cd_project` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=314 DEFAULT CHARSET=utf8;

#dimension
CREATE TABLE `cd_dimension` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `type` varchar(45) NOT NULL,
  `default_hierarchy_id` bigint(20) DEFAULT NULL,
  `dimension_table_id` bigint(20) DEFAULT NULL,
  `project_id` bigint(20) NOT NULL,
  `owner` varchar(255) NOT NULL DEFAULT 'hive',
  PRIMARY KEY (`id`),
  KEY `fk_cd_dimension_1_idx` (`project_id`),
  KEY `fk_cd_dimension_3_idx` (`dimension_table_id`),
  KEY `search_keyword_1` (`name`),
  KEY `search_keyword_2` (`description`),
  CONSTRAINT `fk_cd_dimension_1` FOREIGN KEY (`project_id`) REFERENCES `cd_project` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_dimension_3` FOREIGN KEY (`dimension_table_id`) REFERENCES `cd_table_reference` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=231 DEFAULT CHARSET=utf8;

#level
CREATE TABLE `cd_level` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `dimension_id` bigint(20) NOT NULL,
  `owner` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_level_1_idx` (`dimension_id`),
  CONSTRAINT `fk_cd_level_1` FOREIGN KEY (`dimension_id`) REFERENCES `cd_dimension` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=152 DEFAULT CHARSET=utf8;

#attribute
CREATE TABLE `cd_attribute` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `expression` varchar(255) DEFAULT NULL,
  `level_id` bigint(20) NOT NULL,
  `owner` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_attribute_1_idx` (`level_id`),
  CONSTRAINT `fk_cd_attribute_1` FOREIGN KEY (`level_id`) REFERENCES `cd_level` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=241 DEFAULT CHARSET=utf8;

#hierarchy
CREATE TABLE `cd_hierarchy` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL,
  `description` varchar(255) DEFAULT NULL,
  `dimension_id` bigint(20) NOT NULL,
  `owner` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_hierarchy_1_idx` (`dimension_id`),
  CONSTRAINT `fk_cd_hierarchy_1` FOREIGN KEY (`dimension_id`) REFERENCES `cd_dimension` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=141 DEFAULT CHARSET=utf8;

#hierarchy level association
CREATE TABLE `cd_hierarchy_level` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `hierarchy_id` bigint(20) NOT NULL,
  `level_id` bigint(20) NOT NULL,
  `level_order` int(11) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_hierarchy_level_1_idx` (`hierarchy_id`),
  KEY `fk_cd_hierarchy_level_2_idx` (`level_id`),
  CONSTRAINT `fk_cd_hierarchy_level_1` FOREIGN KEY (`hierarchy_id`) REFERENCES `cd_hierarchy` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_hierarchy_level_2` FOREIGN KEY (`level_id`) REFERENCES `cd_level` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

#cube model
CREATE TABLE `cd_model` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `fact_table_id` bigint(20) DEFAULT NULL,
  `filter` text,
  `image` mediumblob,
  `project_id` bigint(20) NOT NULL,
  `owner` varchar(255) NOT NULL DEFAULT 'hive',
  PRIMARY KEY (`id`),
  KEY `fk_cd_cube_1_idx` (`project_id`),
  KEY `fk_cd_cube_2_idx` (`fact_table_id`),
  KEY `search_keyword_1` (`name`),
  KEY `search_keyword_2` (`description`),
  CONSTRAINT `fk_cd_model_1` FOREIGN KEY (`fact_table_id`) REFERENCES `cd_table_reference` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_model_2` FOREIGN KEY (`project_id`) REFERENCES `cd_project` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=265 DEFAULT CHARSET=utf8;

#measure expression for cube model
CREATE TABLE `cd_expression` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL,
  `description` varchar(255) DEFAULT NULL,
  `expression` varchar(255) NOT NULL,
  `model_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_measure_1_idx` (`model_id`),
  CONSTRAINT `fk_cd_expression_1` FOREIGN KEY (`model_id`) REFERENCES `cd_model` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=338 DEFAULT CHARSET=utf8;

#cube model and dimension association
CREATE TABLE `cd_model_dimension` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `model_id` bigint(20) NOT NULL,
  `dimension_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_cube_dimension_1_idx` (`model_id`),
  KEY `fk_cd_cube_dimension_2_idx` (`dimension_id`),
  CONSTRAINT `fk_cd_model_dimension_1` FOREIGN KEY (`model_id`) REFERENCES `cd_model` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_model_dimension_2` FOREIGN KEY (`dimension_id`) REFERENCES `cd_dimension` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=367 DEFAULT CHARSET=utf8;

#cube instance
CREATE TABLE `cd_cube` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL,
  `description` varchar(255) DEFAULT NULL,
  `database` varchar(255) NOT NULL,
  `type` varchar(45) NOT NULL,
  `creation_time` timestamp NULL DEFAULT NULL,
  `frequency_type` varchar(45) DEFAULT NULL,
  `frequency_size` int(11) DEFAULT NULL,
  `rule_is_used` tinyint(4) DEFAULT NULL,
  `rule_start_at_once` tinyint(4) NOT NULL,
  `status` varchar(45) NOT NULL DEFAULT 'EMPTY',
  `filter` varchar(255) DEFAULT NULL,
  `is_aggregated` tinyint(4) NOT NULL,
  `use_times` int(11) NOT NULL DEFAULT '0',
  `sql_optimizer` varchar(256) DEFAULT NULL,
  `creation_sql` longtext,
  `model_id` bigint(20) NOT NULL,
  `owner` varchar(255) NOT NULL DEFAULT 'hive',
  `workflow_id` bigint(20) DEFAULT NULL,
  `storage_size` bigint(20) NOT NULL DEFAULT '0',
  PRIMARY KEY (`id`),
  KEY `fk_cd_cube_1_idx` (`model_id`),
  CONSTRAINT `fk_cd_cube_1` FOREIGN KEY (`model_id`) REFERENCES `cd_model` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=261 DEFAULT CHARSET=utf8;

#measure for cube instance
CREATE TABLE `cd_measure` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `name` varchar(255) DEFAULT NULL,
  `description` varchar(255) DEFAULT NULL,
  `aggregation_type` varchar(45) DEFAULT NULL,
  `measure_expression_id` bigint(20) NOT NULL,
  `cube_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_measure_1_idx` (`cube_id`),
  KEY `fk_cd_measure_2_idx` (`measure_expression_id`),
  CONSTRAINT `fk_cd_measure_1` FOREIGN KEY (`cube_id`) REFERENCES `cd_cube` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_measure_2` FOREIGN KEY (`measure_expression_id`) REFERENCES `cd_expression` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=485 DEFAULT CHARSET=utf8;

#cube instance and hierarchy association
CREATE TABLE `cd_cube_hierarchy` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `cube_id` bigint(20) NOT NULL,
  `hierarchy_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_cube_hierarchy_1_idx` (`cube_id`),
  KEY `fk_cd_cube_hierarchy_2_idx` (`hierarchy_id`),
  CONSTRAINT `fk_cd_cube_hierarchy_1` FOREIGN KEY (`cube_id`) REFERENCES `cd_cube` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_cube_hierarchy_2` FOREIGN KEY (`hierarchy_id`) REFERENCES `cd_hierarchy` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=777 DEFAULT CHARSET=utf8;

#groups for user chosen manually
CREATE TABLE `cd_group_by` (
  `group_by_id` bigint(20) NOT NULL,
  `level_id` bigint(20) NOT NULL,
  `cube_id` bigint(20) NOT NULL,
  KEY `fk_cd_cube_level_1_idx` (`cube_id`),
  KEY `fk_cd_cube_level_2_idx` (`level_id`),
  CONSTRAINT `fk_cd_group_by_1` FOREIGN KEY (`level_id`) REFERENCES `cd_level` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_group_by_2` FOREIGN KEY (`cube_id`) REFERENCES `cd_cube` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

#cube creation sql for inceptor mbo rewrite sql
CREATE TABLE `cd_cube_creation_sql` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `database` varchar(255) DEFAULT NULL,
  `table_name` varchar(255) NOT NULL,
  `component_table_name` varchar(255) DEFAULT NULL,
  `table_creation_sql` longtext NOT NULL,
  `cube_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_index1` (`table_name`,`database`),
  KEY `cd_cube_creation_sql_cd_cube_id_fk` (`cube_id`),
  CONSTRAINT `cd_cube_creation_sql_cd_cube_id_fk` FOREIGN KEY (`cube_id`) REFERENCES `cd_cube` (`id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=301 DEFAULT CHARSET=latin1;

#task to record cube instance build cube and clear cube task
CREATE TABLE `cd_task` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `start_time` bigint(20) DEFAULT NULL,
  `end_time` bigint(20) DEFAULT NULL,
  `task_type` varchar(255) DEFAULT NULL,
  `status` varchar(45) DEFAULT NULL,
  `progress` double DEFAULT NULL,
  `database` varchar(255) DEFAULT NULL,
  `storage_type` varchar(255) DEFAULT NULL,
  `storage_size` bigint(20) DEFAULT NULL,
  `cube_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_task_1_idx` (`cube_id`),
  CONSTRAINT `fk_cd_task_1` FOREIGN KEY (`cube_id`) REFERENCES `cd_cube` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=238 DEFAULT CHARSET=latin1;

#sub task to record information of execution of each ddl
CREATE TABLE `cd_sub_task` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `start_time` bigint(20) DEFAULT NULL,
  `end_time` bigint(20) DEFAULT NULL,
  `status` varchar(45) DEFAULT NULL,
  `database` varchar(255) DEFAULT NULL,
  `table_name` varchar(255) DEFAULT NULL,
  `sql` text,
  `storage_type` varchar(45) DEFAULT NULL,
  `storage_size` bigint(20) DEFAULT NULL,
  `log` text,
  `creation_time` bigint(20) DEFAULT NULL,
  `last_update_time` varchar(45) DEFAULT NULL,
  `task_id` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=MyISAM AUTO_INCREMENT=117 DEFAULT CHARSET=latin1;

#statistic information for dash bord
CREATE TABLE `cd_statistic_info` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `date` bigint(20) DEFAULT NULL,
  `storage_size` bigint(20) DEFAULT NULL,
  `rule_num` bigint(20) DEFAULT NULL,
  `task_num` bigint(20) DEFAULT NULL,
  `dimension_num` bigint(20) DEFAULT NULL,
  `cube_model_num` bigint(20) DEFAULT NULL,
  `cube_num` bigint(20) DEFAULT NULL,
  `connection_id` bigint(20) DEFAULT NULL,
  `project_id` bigint(20) DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_statistic_info_1_idx` (`connection_id`),
  KEY `fk_cd_statistic_info_2_idx` (`project_id`),
  CONSTRAINT `fk_cd_statistic_info_1` FOREIGN KEY (`connection_id`) REFERENCES `cd_server_connection` (`id`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `fk_cd_statistic_info_2` FOREIGN KEY (`project_id`) REFERENCES `cd_project` (`id`) ON DELETE CASCADE ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=939 DEFAULT CHARSET=latin1;

#table reference join
CREATE TABLE `cd_table_join` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `left_table_id` bigint(20) NOT NULL,
  `right_table_id` bigint(20) NOT NULL,
  `type` varchar(45) NOT NULL,
  `expression` varchar(255) NOT NULL,
  `belong_to_type` varchar(45) NOT NULL,
  `belong_to_id` bigint(20) NOT NULL,
  PRIMARY KEY (`id`),
  KEY `fk_cd_table_join_2_idx` (`right_table_id`),
  KEY `fk_cd_table_join_1_idx` (`left_table_id`),
  CONSTRAINT `fk_cd_table_join_1` FOREIGN KEY (`left_table_id`) REFERENCES `cd_table_reference` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `fk_cd_table_join_2` FOREIGN KEY (`right_table_id`) REFERENCES `cd_table_reference` (`id`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB AUTO_INCREMENT=379 DEFAULT CHARSET=utf8;


